---
import { getSite, type Locale } from '../i18n/utils';

interface Props {
  title?: string;
  description?: string;
  lang?: Locale;
}

const { title, description, lang = 'en' } = Astro.props;
const site = getSite(lang);
const pageTitle = title ? `${title} | ${site.title}` : site.title;
const pageDescription = description || site.description;
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={pageDescription} />
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    {lang === 'ja' && (
      <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap"
        rel="stylesheet"
      />
    )}
    <title>{pageTitle}</title>
    <!-- Theme detection: runs before render to prevent flash -->
    <script is:inline>
      (function() {
        var stored = localStorage.getItem('theme');
        if (stored === 'dark' || (!stored && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        }
      })();
    </script>
  </head>
  <body class="bg-white dark:bg-black text-gray-900 dark:text-white font-sans min-h-screen">
    <slot />
    <!-- Staging password gate -->
    <script is:inline>
    (function() {
      var STAGING_HOST = 'staging.gszep.com';
      var SESSION_KEY = 'staging-auth';
      var PASSWORD = 'preview';
      if (window.location.hostname !== STAGING_HOST) return;
      if (sessionStorage.getItem(SESSION_KEY) === 'ok') return;
      document.documentElement.style.visibility = 'hidden';
      document.addEventListener('DOMContentLoaded', function() {
        var overlay = document.createElement('div');
        overlay.style.cssText = 'position:fixed;inset:0;z-index:99999;background:#fff;display:flex;align-items:center;justify-content:center;font-family:sans-serif';
        overlay.innerHTML =
          '<form id="gate-form" style="text-align:center;max-width:320px;width:100%;padding:2rem">' +
          '<h2 style="margin:0 0 0.5rem;font-size:1.25rem;font-weight:600">Staging Preview</h2>' +
          '<p style="margin:0 0 1.5rem;color:#666;font-size:0.875rem">Enter password to continue</p>' +
          '<input id="gate-password" type="password" placeholder="Password" autofocus ' +
          'style="width:100%;padding:0.625rem;border:1px solid #ccc;border-radius:4px;font-size:1rem;margin-bottom:0.75rem;box-sizing:border-box">' +
          '<button type="submit" style="width:100%;padding:0.625rem;background:#333;color:#fff;border:none;border-radius:4px;font-size:1rem;cursor:pointer">Enter</button>' +
          '<p id="gate-error" style="color:#c00;margin:0.75rem 0 0;font-size:0.875rem;display:none">Incorrect password</p>' +
          '</form>';
        document.body.appendChild(overlay);
        document.documentElement.style.visibility = 'visible';
        document.getElementById('gate-form').addEventListener('submit', function(e) {
          e.preventDefault();
          var input = document.getElementById('gate-password');
          if (input.value === PASSWORD) {
            sessionStorage.setItem(SESSION_KEY, 'ok');
            overlay.remove();
            window.location.reload();
          } else {
            document.getElementById('gate-error').style.display = 'block';
            input.value = '';
            input.focus();
          }
        });
      });
    })();
    </script>
  </body>
</html>
---
import ThemeToggle from './ThemeToggle.astro';
import LangToggle from './LangToggle.astro';
import { t, getSite, localizedPath, type Locale } from '../../i18n/utils';

interface Props {
  lang?: Locale;
}

const { lang = 'en' } = Astro.props;
const site = getSite(lang);
const currentPath = Astro.url.pathname;
const switchPath = lang === 'en'
  ? `/ja${currentPath}`
  : currentPath.replace(/^\/ja/, '') || '/';
const homeHref = localizedPath(lang, '/');
---

<nav class="fixed top-0 w-full bg-white dark:bg-black z-50" role="navigation" aria-label="main navigation" data-lang={lang}>
  <div class="max-w-6xl mx-auto px-4 flex items-center justify-between h-16">
    <a href={homeHref} class="font-bold text-gray-900 dark:text-white text-lg">{site.title}</a>

    <!-- Desktop nav -->
    <div class="hidden md:flex items-center gap-6 text-sm uppercase tracking-wide">
      <a href={homeHref} data-section="hero" class="nav-link text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-300">{t(lang, 'nav.home')}</a>
      <a href={`${homeHref}#blog`} data-section="blog" class="nav-link text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-300">{t(lang, 'nav.blog')}</a>
      <a href={`${homeHref}#contact`} data-section="contact" class="nav-link text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-300">{t(lang, 'nav.contact')}</a>
      <LangToggle lang={lang} switchPath={switchPath} />
      <ThemeToggle lang={lang} />
    </div>

    <!-- Mobile: toggle + burger -->
    <div class="flex items-center gap-2 md:hidden">
      <LangToggle lang={lang} switchPath={switchPath} />
      <ThemeToggle lang={lang} />
      <button
        class="text-gray-900 dark:text-white"
        id="nav-burger"
        aria-label={t(lang, 'nav.toggle')}
        aria-expanded="false"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile menu -->
  <div class="hidden md:hidden bg-white dark:bg-black px-4 pb-4" id="nav-menu">
    <a href={homeHref} data-section="hero" class="nav-link block py-2 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white uppercase text-sm">{t(lang, 'nav.home')}</a>
    <a href={`${homeHref}#blog`} data-section="blog" class="nav-link block py-2 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white uppercase text-sm">{t(lang, 'nav.blog')}</a>
    <a href={`${homeHref}#contact`} data-section="contact" class="nav-link block py-2 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white uppercase text-sm">{t(lang, 'nav.contact')}</a>
  </div>
</nav>

<script>
  // Mobile menu toggle
  const burger = document.getElementById('nav-burger');
  const menu = document.getElementById('nav-menu');
  burger?.addEventListener('click', () => {
    menu?.classList.toggle('hidden');
    const expanded = burger.getAttribute('aria-expanded') === 'true';
    burger.setAttribute('aria-expanded', String(!expanded));
  });
  menu?.querySelectorAll('a').forEach((link) => {
    link.addEventListener('click', () => {
      menu.classList.add('hidden');
      burger?.setAttribute('aria-expanded', 'false');
    });
  });

  // Active nav link highlighting
  const navLinks = document.querySelectorAll<HTMLAnchorElement>('.nav-link');

  function setActive(sectionId: string) {
    navLinks.forEach((link) => {
      const isActive = link.dataset.section === sectionId;
      link.classList.toggle('text-gray-900', isActive);
      link.classList.toggle('dark:text-white', isActive);
      link.classList.toggle('text-gray-500', !isActive);
      link.classList.toggle('dark:text-gray-400', !isActive);
    });
  }

  // On homepage: scroll-based section highlighting
  const homePaths = ['/', '/ja/', '/ja'];
  const isHomepage = homePaths.includes(window.location.pathname);
  const homeSections = ['hero', 'blog', 'contact'];
  const sections = isHomepage
    ? homeSections.map((id) => document.getElementById(id)).filter(Boolean) as HTMLElement[]
    : [];

  if (sections.length === homeSections.length) {
    function updateActiveSection() {
      const scrollY = window.scrollY + window.innerHeight * 0.35;
      let activeId = sections[0].id;

      for (const section of sections) {
        if (section.offsetTop <= scrollY) {
          activeId = section.id;
        }
      }

      // At the very bottom of the page, activate contact
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 2) {
        activeId = 'contact';
      }

      setActive(activeId);
    }

    window.addEventListener('scroll', updateActiveSection, { passive: true });
    updateActiveSection();
  } else {
    // On non-homepage: highlight based on URL path
    const path = window.location.pathname;
    if (path.includes('/blog')) {
      setActive('blog');
    }
  }
</script>
---
/**
 * WebGPU sumi-e ink wash rendering of the plum blossom video
 * with physarum-inspired calligraphic brush strokes.
 *
 * The video plays normally as both the visual fallback and the texture
 * source for the NPR shader. When WebGPU is available the canvas
 * overlays the video with ink wash rendering driven by physarum agents;
 * when not, the raw video remains visible.
 *
 * Includes a lil-gui panel for real-time parameter tuning.
 */
---

<div class="plum-painting">
  <video
    id="plum-video"
    autoplay
    loop
    muted
    playsinline
    src="/images/mito-plum-festival.mp4"
  ></video>
  <canvas id="plum-sumi"></canvas>
</div>

<style>
  .plum-painting {
    position: relative;
    overflow: hidden;
  }

  .plum-painting video {
    width: 100%;
    max-height: 80vh;
    object-fit: cover;
    object-position: 50% 20%;
    display: block;
  }

  .plum-painting canvas {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }

  .plum-painting > :global(.lil-gui) {
    position: absolute;
    top: 8px;
    left: 8px;
    z-index: 10;
  }
</style>

<script>
  import { BrushStroke } from "./webgpu/BrushStroke";
  import GUI from "lil-gui";

  const canvas = document.getElementById("plum-sumi") as HTMLCanvasElement | null;
  const video = document.getElementById("plum-video") as HTMLVideoElement | null;

  if (canvas && video) {
    const sim = new BrushStroke({ canvas, video });

    sim.start().then((ok) => {
      if (ok) {
        new ResizeObserver(() => sim.handleResize()).observe(canvas);

        // Tuning GUI (collapsed, top-left corner of simulation)
        const gui = new GUI({ title: "Sumi-e", autoPlace: false });
        gui.close();
        canvas.parentElement!.appendChild(gui.domElement);

        const physarum = gui.addFolder("Physarum");
        physarum.add(sim.tuning, "sensorDist", 1, 40, 0.5).name("sensor dist");
        physarum.add(sim.tuning, "sensorAngle", 0.05, 1.57, 0.01).name("sensor angle");
        physarum.add(sim.tuning, "turnSpeed", 0.01, 1.0, 0.01).name("turn speed");
        physarum.add(sim.tuning, "deposit", 0.01, 2.0, 0.01).name("deposit");
        physarum.add(sim.tuning, "trailSpeed", 0.1, 5.0, 0.1).name("speed");
        physarum.add(sim.tuning, "maskWeight", 0, 10, 0.1).name("mask attract");
        physarum.add(sim.tuning, "trailDecay", 0.9, 1.0, 0.001).name("decay");
        physarum.add(sim.tuning, "diffuseWeight", 0, 1, 0.01).name("diffuse");
        physarum.add(sim.tuning, "physarumSteps", 1, 16, 1).name("steps/frame");

        const ink = gui.addFolder("Ink");
        ink.add(sim.tuning, "branchInk", 0, 1, 0.01).name("branch opacity");
        ink.add(sim.tuning, "skyInk", 0, 0.3, 0.005).name("sky wash");
        ink.add(sim.tuning, "paperTone", 0.85, 1, 0.005).name("paper tone");

        const segment = gui.addFolder("Segmentation");
        segment.add(sim.tuning, "branchLum", 0, 1, 0.01).name("luminance");
        segment.add(sim.tuning, "branchEdge", 0, 0.3, 0.005).name("contrast");
        segment.add(sim.tuning, "maskThreshold", 0, 1, 0.01).name("mask cutoff");
        segment.add(sim.tuning, "erosionSteps", 0, 200, 1).name("erosion steps");
        segment.addColor(sim.tuning, "attractColor").name("attract color");
        segment.add(sim.tuning, "colorTolerance", 0.01, 1.0, 0.01).name("tolerance");
        segment.add(sim.tuning, "agentThreshold", 0, 1, 0.01).name("agent mask");

        const blossom = gui.addFolder("Blossom");
        blossom.add(sim.tuning, "blossomInk", 0, 1, 0.01).name("pink strength");
        // Spacebar: copy current parameters to clipboard
        document.addEventListener("keydown", (e) => {
          if (e.code !== "Space" || e.target !== document.body) return;
          e.preventDefault();
          const t = sim.tuning;
          const text = [
            `sensor dist ${t.sensorDist}`,
            `angle ${t.sensorAngle}`,
            `turn speed ${t.turnSpeed}`,
            `deposit ${t.deposit}`,
            `speed ${t.trailSpeed}`,
            `mask attract ${t.maskWeight}`,
            `decay ${t.trailDecay}`,
            `diffuse ${t.diffuseWeight}`,
            `steps ${t.physarumSteps}`,
            `attract color ${t.attractColor.replace("#", "")}`,
            `tolerance ${t.colorTolerance}`,
            `erosion steps ${t.erosionSteps}`,
            `mask cutoff ${t.maskThreshold}`,
            `contrast ${t.branchEdge}`,
            `luminance ${t.branchLum}`,
            `agent mask ${t.agentThreshold}`,
            `pink strength ${t.blossomInk}`,
            `sky wash ${t.skyInk}`,
            `paper tone ${t.paperTone}`,
          ].join(", ");
          navigator.clipboard.writeText(text);
          console.log("[params copied]", text);
        });
      } else {
        // WebGPU unavailable â€” remove canvas, raw video stays visible
        canvas.remove();
      }
    });
  }
</script>
